<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตะกร้าสินค้าและชำระเงิน - OTOP ชุมชนบ้านนาเวียง</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/cart.css">
</head>
<body>
    <nav id="navbar">
        <div class="nav-container">
            <a href="/index.html" class="nav-logo-container animate-fadeIn"><img src="img/logo-main.png" alt="โลโก้ OTOP" class="nav-logo"></a>
            <ul class="nav-links">
                <li><a href="home.html" class="nav-link">หน้าแรก</a></li>
                <li><a href="products.html" class="nav-link">สินค้า</a></li>
                <li><a href="about.html" class="nav-link">เกี่ยวกับชุมชน</a></li>
                <li><a href="contact.html" class="nav-link">ติดต่อ</a></li>
                <li><a href="account.html" class="nav-link">บัญชี</a></li>
                <li><a href="cart.html" class="nav-link active"><i class="fas fa-shopping-cart"></i> ตะกร้าสินค้า</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="cart-checkout-wrapper animate-fadeInUp reveal">
                <div class="cart active" id="cart-section">
                    <h1>ตะกร้าสินค้าของคุณ</h1>
                    <div class="cart-items"></div>
                    <div class="cart-total">รวม: 0 บาท</div>
                    <div class="cart-checkout">
                        <button onclick="showCheckout()"><i class="fas fa-money-check-alt"></i> ดำเนินการชำระเงิน</button>
                    </div>
                </div>
                <div class="checkout" id="checkout-section">
                    <h1>ชำระเงิน</h1>
                    <p>กรุณากรอกข้อมูลด้านล่าง/รอแอดมินติดต่อไปเพื่อชำระเงิน</p>
                    <form class="checkout-form" id="checkout-form">
                        <div class="form-group">
                            <label for="name">ชื่อ-นามสกุล</label>
                            <input type="text" id="name" required placeholder="กรอกชื่อ-นามสกุล">
                        </div>
                        <div class="form-group">
                            <label for="phone">เบอร์โทรศัพท์</label>
                            <input type="tel" id="phone" required placeholder="กรอกเบอร์โทรศัพท์">
                        </div>
                        <div class="form-group">
                            <label>ที่อยู่</label>
                            <div class="address-radio-group" id="address-radio-group"></div>
                        </div>
                        <div class="new-address" id="new-address" style="display: none;">
                            <div class="form-group">
                                <label for="new-street">บ้านเลขที่/หมู่/ถนน</label>
                                <input type="text" id="new-street" placeholder="กรอกบ้านเลขที่/หมู่/ถนน">
                            </div>
                            <div class="form-group">
                                <label for="new-province">จังหวัด</label>
                                <select id="new-province" onchange="populateNewDistricts(this.value)">
                                    <option value="">เลือกจังหวัด</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-district">อำเภอ</label>
                                <select id="new-district" onchange="populateNewSubdistricts(document.getElementById('new-province').value, this.value)" disabled>
                                    <option value="">เลือกอำเภอ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-subdistrict">ตำบล</label>
                                <select id="new-subdistrict" onchange="updateNewZipcode()" disabled>
                                    <option value="">เลือกตำบล</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-zipcode">รหัสไปรษณีย์</label>
                                <input type="text" id="new-zipcode" readonly>
                            </div>
                        </div>
                        <button type="button" class="new-address-btn" onclick="addNewAddress()">เพิ่มที่อยู่ใหม่</button>
                        <div class="cart-summary">
                            <h3>สรุปคำสั่งซื้อ</h3>
                            <div id="cart-summary-items"></div>
                            <div>ชำระเงินปลายทาง</div>
                            <div class="total">รวม: 0 บาท</div>
                        </div>
                        <div class="checkout-buttons">
                            <button type="button" class="confirm-btn" onclick="confirmCheckout()">ยืนยันการสั่งซื้อ</button>
                            <button type="button" class="cancel-btn" onclick="showCart()">ย้อนกลับ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div class="custom-alert-overlay" id="alert-overlay" onclick="closeCustomAlert()">
        <div class="custom-alert" onclick="event.stopPropagation()">
            <div class="alert-content">
                <i id="alert-icon" class="fas fa-check-circle"></i>
                <h4 id="alert-title">สำเร็จ!</h4>
                <p id="alert-message">ข้อความแจ้งเตือน</p>
            </div>
            <button onclick="closeCustomAlert()">ตกลง</button>
        </div>
    </div>

    <footer id="contact">
        <div class="footer-container">
            <div class="footer-section reveal">
                <h3>เกี่ยวกับร้าน OTOP ชุมชน</h3>
                <p>เราคือร้านค้าที่นำเสนอผลิตภัณฑ์ OTOP คุณภาพสูงจากชุมชนบ้านนาเวียง สนับสนุนงานฝีมือท้องถิ่นและความยั่งยืน</p>
                <div class="social-icons">
                    <a href="https://www.facebook.com/frxme.kitisuk" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://line.me/ti/p/MLQ2KzX_hh" class="social-icon"><i class="fab fa-line"></i></a>
                    <a href="https://www.instagram.com/f4x_me/" class="social-icon"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="footer-section reveal">
                <h3>ลิงก์ด่วน</h3>
                <ul class="footer-links">
                    <li><a href="home.html" class="footer-link">หน้าแรก</a></li>
                    <li><a href="products.html" class="footer-link">สินค้า</a></li>
                    <li><a href="about.html" class="footer-link">เกี่ยวกับชุมชน</a></li>
                    <li><a href="contact.html" class="footer-link">ติดต่อ</a></li>
                </ul>
            </div>
            <div class="footer-section reveal">
                <h3>ติดต่อเรา</h3>
                <p><i class="fas fa-envelope"></i> อีเมล: piyasanw@gmail.com</p>
                <p><i class="fas fa-phone-alt"></i> โทร: 06-23892553</p>
                <p><i class="fas fa-map-marker-alt"></i> ที่อยู่: หมู่ 1 ต.นาเวียง อ.เสนางคนิคม จ.อำนาจเจริญ 37290</p>
            </div>
        </div>
        <div class="footer-credit reveal">
            <p>© 2025 ร้าน OTOP ชุมชนบ้านนาเวียง. สงวนลิขสิทธิ์.</p>
        </div>
    </footer>


    <script>
        // Generate unique order ID
        function generateOrderId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `ORD${timestamp}${random}`;
        }

        // Cart Management
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function updateCart() {
            const cartItemsContainer = document.querySelector('.cart-items');
            const cartSummaryItems = document.getElementById('cart-summary-items');
            cartItemsContainer.innerHTML = '';
            cartSummaryItems.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p style="text-align: center; color: #4b5563;">ตะกร้าสินค้าว่างเปล่า</p>';
            }

            cart.forEach((item, index) => {
                total += item.price * item.quantity;
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item animate-fadeInUp reveal';
                cartItem.style.animationDelay = `${index * 0.1}s`;
                cartItem.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.price} บาท x ${item.quantity}</p>
                    </div>
                    <div class="cart-item-controls">
                        <button onclick="updateQuantity(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateQuantity(${index}, 1)">+</button>
                        <button class="delete-btn" onclick="removeFromCart(${index})"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItem);

                const summaryItem = document.createElement('div');
                summaryItem.className = 'cart-summary-item';
                summaryItem.innerHTML = `
                    <p>${item.name} x ${item.quantity}</p>
                    <p>${item.price * item.quantity} บาท</p>
                `;
                cartSummaryItems.appendChild(summaryItem);
            });
            document.querySelector('.cart-total').textContent = `รวม: ${total} บาท`;
            document.querySelector('.cart-summary .total').textContent = `รวม: ${total} บาท`;
        }

        function updateQuantity(index, change) {
            cart[index].quantity += change;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
            saveCart();
            updateCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            saveCart();
            updateCart();
            showCustomAlert('success', 'ลบสินค้าเรียบร้อย', 'สินค้าถูกลบออกจากตะกร้าแล้วค่ะ');
        }

        // Address Management
        async function loadAddresses() {
            const addressRadioGroup = document.getElementById('address-radio-group');
            addressRadioGroup.innerHTML = '';
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const loggedInEmail = localStorage.getItem('loggedInEmail');
            const user = users.find(u => u.email === loggedInEmail);
            const addresses = user ? user.addresses || [] : [];

            // Fetch address data for dropdowns
            let addressData = { provinces: [] };
            try {
                const response = await fetch('https://raw.githubusercontent.com/thailand-geography-data/thailand-geography-json/main/src/geography.json');
                if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลที่อยู่ได้');
                const data = await response.json();
                const provinces = {};
                data.forEach(item => {
                    if (!provinces[item.provinceNameTh]) {
                        provinces[item.provinceNameTh] = { districts: {} };
                    }
                    if (!provinces[item.provinceNameTh].districts[item.districtNameTh]) {
                        provinces[item.provinceNameTh].districts[item.districtNameTh] = { subdistricts: [] };
                    }
                    provinces[item.provinceNameTh].districts[item.districtNameTh].subdistricts.push({
                        name: item.subdistrictNameTh,
                        zipcode: item.postalCode
                    });
                });
                addressData = {
                    provinces: Object.keys(provinces).map(name => ({
                        name,
                        districts: Object.keys(provinces[name].districts).map(districtName => ({
                            name: districtName,
                            subdistricts: provinces[name].districts[districtName].subdistricts
                        }))
                    }))
                };
            } catch (error) {
                console.error('Error fetching address data:', error);
            }

            // Add existing addresses
            addresses.forEach((addr, index) => {
                const radioCard = document.createElement('div');
                radioCard.className = 'address-radio-card';
                radioCard.innerHTML = `
                    <input type="radio" name="address" id="address-${index}" value="${index}" onchange="toggleNewAddress()">
                    <label for="address-${index}">${addr.street}, ต.${addr.subdistrict}, อ.${addr.district}, จ.${addr.province}, ${addr.zipcode}</label>
                    <div class="address-radio-content">
                        <p><strong>บ้านเลขที่/หมู่/ถนน:</strong> ${addr.street}</p>
                        <p><strong>ตำบล:</strong> ${addr.subdistrict}</p>
                        <p><strong>อำเภอ:</strong> ${addr.district}</p>
                        <p><strong>จังหวัด:</strong> ${addr.province}</p>
                        <p><strong>รหัสไปรษณีย์:</strong> ${addr.zipcode}</p>
                    </div>
                `;
                addressRadioGroup.appendChild(radioCard);
            });

            // Add "New Address" option
            const newAddressRadio = document.createElement('div');
            newAddressRadio.className = 'address-radio-card new-address-card';
            newAddressRadio.innerHTML = `
                <input type="radio" name="address" id="new-address-radio" value="new" onchange="toggleNewAddress()">
                <label for="new-address-radio">เพิ่มที่อยู่ใหม่</label>
                <div class="address-radio-content">
                    <p>กรอกที่อยู่ใหม่ในฟอร์มด้านล่าง</p>
                </div>
            `;
            addressRadioGroup.appendChild(newAddressRadio);

            // Update new address form with dropdowns
            const newAddressSection = document.getElementById('new-address');
            newAddressSection.innerHTML = `
                <div class="form-group">
                    <label for="new-street">บ้านเลขที่/หมู่/ถนน</label>
                    <input type="text" id="new-street" placeholder="กรอกบ้านเลขที่/หมู่/ถนน">
                </div>
                <div class="form-group">
                    <label for="new-province">จังหวัด</label>
                    <select id="new-province" onchange="populateNewDistricts(this.value)">
                        <option value="">เลือกจังหวัด</option>
                        ${addressData.provinces.sort((a, b) => a.name.localeCompare(b.name, 'th')).map(province => `<option value="${province.name}">${province.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-district">อำเภอ</label>
                    <select id="new-district" onchange="populateNewSubdistricts(document.getElementById('new-province').value, this.value)" disabled>
                        <option value="">เลือกอำเภอ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-subdistrict">ตำบล</label>
                    <select id="new-subdistrict" onchange="updateNewZipcode()" disabled>
                        <option value="">เลือกตำบล</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-zipcode">รหัสไปรษณีย์</label>
                    <input type="text" id="new-zipcode" readonly>
                </div>
            `;

            toggleNewAddress();
        }

        async function populateNewDistricts(province) {
            const districtSelect = document.getElementById('new-district');
            const subdistrictSelect = document.getElementById('new-subdistrict');
            const zipcodeInput = document.getElementById('new-zipcode');
            districtSelect.innerHTML = '<option value="">เลือกอำเภอ</option>';
            subdistrictSelect.innerHTML = '<option value="">เลือกตำบล</option>';
            districtSelect.disabled = true;
            subdistrictSelect.disabled = true;
            zipcodeInput.value = '';

            if (province) {
                const response = await fetch('https://raw.githubusercontent.com/thailand-geography-data/thailand-geography-json/main/src/geography.json');
                if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลที่อยู่ได้');
                const data = await response.json();
                const provinces = {};
                data.forEach(item => {
                    if (!provinces[item.provinceNameTh]) {
                        provinces[item.provinceNameTh] = { districts: {} };
                    }
                    if (!provinces[item.provinceNameTh].districts[item.districtNameTh]) {
                        provinces[item.provinceNameTh].districts[item.districtNameTh] = { subdistricts: [] };
                    }
                    provinces[item.provinceNameTh].districts[item.districtNameTh].subdistricts.push({
                        name: item.subdistrictNameTh,
                        zipcode: item.postalCode
                    });
                });
                const selectedProvince = Object.keys(provinces).find(p => p === province);
                if (selectedProvince) {
                    districtSelect.disabled = false;
                    Object.keys(provinces[selectedProvince].districts).sort((a, b) => a.localeCompare(b, 'th')).forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                }
            }
        }

        async function populateNewSubdistricts(province, district) {
            const subdistrictSelect = document.getElementById('new-subdistrict');
            const zipcodeInput = document.getElementById('new-zipcode');
            subdistrictSelect.innerHTML = '<option value="">เลือกตำบล</option>';
            subdistrictSelect.disabled = true;
            zipcodeInput.value = '';

            if (province && district) {
                const response = await fetch('https://raw.githubusercontent.com/thailand-geography-data/thailand-geography-json/main/src/geography.json');
                if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลที่อยู่ได้');
                const data = await response.json();
                const provinces = {};
                data.forEach(item => {
                    if (!provinces[item.provinceNameTh]) {
                        provinces[item.provinceNameTh] = { districts: {} };
                    }
                    if (!provinces[item.provinceNameTh].districts[item.districtNameTh]) {
                        provinces[item.provinceNameTh].districts[item.districtNameTh] = { subdistricts: [] };
                    }
                    provinces[item.provinceNameTh].districts[item.districtNameTh].subdistricts.push({
                        name: item.subdistrictNameTh,
                        zipcode: item.postalCode
                    });
                });
                const selectedProvince = provinces[province];
                const selectedDistrict = selectedProvince?.districts[district];
                if (selectedDistrict) {
                    subdistrictSelect.disabled = false;
                    selectedDistrict.subdistricts.sort((a, b) => a.name.localeCompare(b.name, 'th')).forEach(subdistrict => {
                        const option = document.createElement('option');
                        option.value = subdistrict.name;
                        option.textContent = subdistrict.name;
                        option.dataset.zipcode = subdistrict.zipcode;
                        subdistrictSelect.appendChild(option);
                    });
                }
            }
        }

        function updateNewZipcode() {
            const subdistrictSelect = document.getElementById('new-subdistrict');
            const zipcodeInput = document.getElementById('new-zipcode');
            const selectedOption = subdistrictSelect.options[subdistrictSelect.selectedIndex];
            zipcodeInput.value = selectedOption?.dataset.zipcode || '';
        }

        function toggleNewAddress() {
            const newAddressSection = document.getElementById('new-address');
            const selectedRadio = document.querySelector('input[name="address"]:checked');
            newAddressSection.style.display = selectedRadio && selectedRadio.value === 'new' ? 'block' : 'none';
        }

        function addNewAddress() {
            const street = document.getElementById('new-street').value;
            const subdistrict = document.getElementById('new-subdistrict').value;
            const district = document.getElementById('new-district').value;
            const province = document.getElementById('new-province').value;
            const zipcode = document.getElementById('new-zipcode').value;
            if (street && subdistrict && district && province && zipcode) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const loggedInEmail = localStorage.getItem('loggedInEmail');
                const userIndex = users.findIndex(u => u.email === loggedInEmail);
                if (userIndex !== -1) {
                    const addresses = users[userIndex].addresses || [];
                    addresses.push({ street, subdistrict, district, province, zipcode });
                    users[userIndex].addresses = addresses;
                    localStorage.setItem('users', JSON.stringify(users));
                    loadAddresses();
                    document.getElementById('new-street').value = '';
                    document.getElementById('new-subdistrict').value = '';
                    document.getElementById('new-district').value = '';
                    document.getElementById('new-province').value = '';
                    document.getElementById('new-zipcode').value = '';
                    document.getElementById('new-address').style.display = 'none';
                    showCustomAlert('success', 'เพิ่มที่อยู่สำเร็จ', 'ที่อยู่ใหม่ถูกเพิ่มเรียบร้อยแล้วค่ะ');
                } else {
                    showCustomAlert('error', 'ข้อผิดพลาด', 'กรุณาล็อกอินก่อนเพิ่มที่อยู่');
                }
            } else {
                showCustomAlert('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่อยู่ให้ครบถ้วน');
            }
        }

        // Toggle Cart and Checkout
        function showCheckout() {
            if (cart.length === 0) {
                showCustomAlert('info', 'ตะกร้าสินค้าว่างเปล่า', 'กรุณาเพิ่มสินค้าลงในตะกร้าก่อนชำระเงินค่ะ');
                return;
            }
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const loggedInEmail = localStorage.getItem('loggedInEmail');
            const user = users.find(u => u.email === loggedInEmail);
            if (!user) {
                showCustomAlert('error', 'กรุณาล็อกอิน', 'คุณต้องล็อกอินก่อนดำเนินการชำระเงิน');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }
            document.getElementById('cart-section').style.display = 'none';
            document.getElementById('checkout-section').style.display = 'block';
            document.getElementById('cart-section').classList.remove('active');
            document.getElementById('checkout-section').classList.add('active');
            updateCart();
            loadAddresses();
            document.getElementById('name').value = user ? `${user.name || ''} ${user.surname || ''}`.trim() : '';
            document.getElementById('phone').value = user && user.phones && user.phones.length > 0 ? user.phones[0] : '';
            window.scrollTo({ top: document.getElementById('checkout-section').offsetTop - 100, behavior: 'smooth' });
        }

        function showCart() {
            document.getElementById('cart-section').style.display = 'block';
            document.getElementById('checkout-section').style.display = 'none';
            document.getElementById('cart-section').classList.add('active');
            document.getElementById('checkout-section').classList.remove('active');
            window.scrollTo({ top: document.getElementById('cart-section').offsetTop - 100, behavior: 'smooth' });
        }

        // Custom Alert Functions
        function showCustomAlert(type, title, message) {
            const overlay = document.getElementById('alert-overlay');
            const alertBox = overlay.querySelector('.custom-alert');
            const icon = document.getElementById('alert-icon');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const button = overlay.querySelector('button');

            alertBox.classList.remove('success', 'error', 'info');
            button.classList.remove('error', 'info');

            if (type === 'success') {
                alertBox.classList.add('success');
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                alertBox.classList.add('error');
                icon.className = 'fas fa-exclamation-circle';
                button.classList.add('error');
            } else if (type === 'info') {
                alertBox.classList.add('info');
                icon.className = 'fas fa-info-circle';
                button.classList.add('info');
            }

            alertTitle.textContent = title;
            alertMessage.textContent = message;
            overlay.classList.add('active');
        }

        function closeCustomAlert() {
            document.getElementById('alert-overlay').classList.remove('active');
        }

        // Checkout Confirmation with Discord Webhook
        async function confirmCheckout() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const selectedRadio = document.querySelector('input[name="address"]:checked');
            let addressDetails;

            const users = JSON.parse(localStorage.getItem('users')) || [];
            const loggedInEmail = localStorage.getItem('loggedInEmail');
            const userIndex = users.findIndex(u => u.email === loggedInEmail);
            if (userIndex === -1) {
                showCustomAlert('error', 'กรุณาล็อกอิน', 'คุณต้องล็อกอินก่อนดำเนินการชำระเงิน');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            const addresses = users[userIndex].addresses || [];
            if (!selectedRadio) {
                showCustomAlert('error', 'ข้อผิดพลาด', 'กรุณาเลือกที่อยู่หรือเพิ่มที่อยู่ใหม่');
                return;
            }

            let newAddress = null;
            if (selectedRadio.value === 'new') {
                const street = document.getElementById('new-street').value;
                const subdistrict = document.getElementById('new-subdistrict').value;
                const district = document.getElementById('new-district').value;
                const province = document.getElementById('new-province').value;
                const zipcode = document.getElementById('new-zipcode').value;
                if (!street || !subdistrict || !district || !province || !zipcode) {
                    showCustomAlert('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่อยู่ให้ครบถ้วน');
                    return;
                }
                newAddress = { street, subdistrict, district, province, zipcode };
                addressDetails = `${street}, ต.${subdistrict}, อ.${district}, จ.${province}, ${zipcode}`;
                addresses.push(newAddress);
                users[userIndex].addresses = addresses;
            } else {
                const selectedAddress = addresses[parseInt(selectedRadio.value)];
                addressDetails = `${selectedAddress.street}, ต.${selectedAddress.subdistrict}, อ.${selectedAddress.district}, จ.${selectedAddress.province}, ${selectedAddress.zipcode}`;
            }

            if (!name || !phone) {
                showCustomAlert('error', 'ข้อผิดพลาด', 'กรุณากรอกชื่อและเบอร์โทรศัพท์');
                return;
            }

            // Update user name and phone
            const [firstName, ...lastName] = name.split(' ');
            users[userIndex].name = firstName;
            users[userIndex].surname = lastName.join(' ');
            if (!users[userIndex].phones) users[userIndex].phones = [];
            if (!users[userIndex].phones.includes(phone)) {
                users[userIndex].phones.push(phone);
            }

            // Generate order ID and save purchase
            const orderId = generateOrderId();
            const orderDetails = {
                id: orderId,
                date: new Date().toISOString().split('T')[0],
                items: cart.map(item => ({
                    product: item.name,
                    quantity: item.quantity,
                    total: item.price * item.quantity
                })),
                total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                address: addressDetails
            };

            // Save purchase to user's purchase history
            if (!users[userIndex].purchases) users[userIndex].purchases = [];
            users[userIndex].purchases.push({
                id: orderId,
                date: orderDetails.date,
                product: cart.map(item => item.name).join(', '),
                quantity: cart.reduce((sum, item) => sum + item.quantity, 0),
                total: orderDetails.total
            });
            localStorage.setItem('users', JSON.stringify(users));

            // Format message for Discord using Embed
            const itemsList = cart.map(item => `• ${item.name} x${item.quantity} (${item.price * item.quantity} บาท)`).join('\n');
            const discordMessage = {
                embeds: [{
                    title: "🛒 คำสั่งซื้อใหม่ - OTOP ชุมชนบ้านนาเวียง",
                    description: `คำสั่งซื้อใหม่จากลูกค้า (รหัส: ${orderId})`,
                    color: 0x22c55e, // สีเขียว (#22c55e)
                    fields: [
                        {
                            name: "📜 รหัสคำสั่งซื้อ",
                            value: orderId,
                            inline: true
                        },
                        {
                            name: "👤 ชื่อลูกค้า",
                            value: name,
                            inline: true
                        },
                        {
                            name: "📞 เบอร์โทรศัพท์",
                            value: phone,
                            inline: true
                        },
                        {
                            name: "🏠 ที่อยู่จัดส่ง",
                            value: addressDetails,
                            inline: false
                        },
                        {
                            name: "🛍️ รายการสินค้า",
                            value: itemsList || "ไม่มีสินค้า",
                            inline: false
                        },
                        {
                            name: "📦 จำนวนสินค้าทั้งหมด",
                            value: `${cart.reduce((sum, item) => sum + item.quantity, 0)} ชิ้น`,
                            inline: true
                        },
                        {
                            name: "💵 ราคารวม",
                            value: `${orderDetails.total} บาท`,
                            inline: true
                        },
                        {
                            name: "📅 วันที่สั่งซื้อ",
                            value: new Date().toLocaleString('th-TH'),
                            inline: false
                        }
                    ],
                    footer: {
                        text: "ขอบคุณที่สนับสนุน OTOP ชุมชนบ้านนาเวียง! | ติดต่อ: piyasanw@gmail.com",
                        icon_url: "https://i.imgur.com/your-logo.png" // แทนที่ด้วย URL โลโก้จริง
                    },
                    timestamp: new Date().toISOString()
                }]
            };

            try {
                const response = await fetch('https://discord.com/api/webhooks/1406904084396638248/6XX-tHZpT-FDlHj_FzS4n5EgU6twgj0qtZdmqlJLPQVmMS7PmGpwFVZl2k3LODtV6OhY', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(discordMessage)
                });

                if (response.ok) {
                    cart = [];
                    saveCart();
                    updateCart();
                    showCustomAlert('success', 'สั่งซื้อสำเร็จ', `คำสั่งซื้อของคุณ (รหัส: ${orderId}) ถูกส่งเรียบร้อยแล้ว! ขอบคุณที่สนับสนุน OTOP ชุมชนบ้านนาเวียง`);
                    setTimeout(() => {
                        window.location.href = 'products.html';
                    }, 2000);
                } else {
                    showCustomAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถส่งคำสั่งซื้อได้ กรุณาลองใหม่');
                }
            } catch (error) {
                showCustomAlert('error', 'เกิดข้อผิดพลาด', 'มีปัญหาการเชื่อมต่อ กรุณาลองใหม่');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            updateCart();
            loadAddresses();
        });

        // Scroll Animation
        window.addEventListener('scroll', () => {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
            
            const reveals = document.querySelectorAll('.reveal');
            for (let i = 0; i < reveals.length; i++) {
                let windowHeight = window.innerHeight;
                let elementTop = reveals[i].getBoundingClientRect().top;
                let elementVisible = 150;
                if (elementTop < windowHeight - elementVisible) {
                    reveals[i].classList.add('active');
                } else {
                    reveals[i].classList.remove('active');
                }
            }
        });
    </script>
</body>
</html>